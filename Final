import streamlit as st
from rembg import remove
from PIL import Image
import io
import zipfile
import random

# Page Config for Mobile
st.set_page_config(page_title="Meesho AI", layout="centered")

st.title("üì∏ Meesho AI Optimizer")
st.info("Upload one image -> Get 15 variations optimized for Meesho.")

uploaded_file = st.file_uploader("Tap to upload product photo", type=["jpg", "jpeg", "png"])

def process_logic(image_bytes, scale_reduction):
    # Remove background
    raw_img = remove(image_bytes)
    img = Image.open(io.BytesIO(raw_img)).convert("RGBA")
    
    # Auto-detect product and crop
    bbox = img.getbbox()
    if bbox:
        img = img.crop(bbox)

    # Meesho Requirements: 2000x2000, White Background
    canvas_size = 2000
    # Logic: Product occupies 65-70% of the canvas
    max_dim = int(canvas_size * (0.65 + (random.uniform(0, 0.05))))
    img.thumbnail((max_dim, max_dim), Image.Resampling.LANCZOS)
    
    # Create Pure White (#FFFFFF)
    final_img = Image.new("RGB", (canvas_size, canvas_size), (255, 255, 255))
    offset = ((canvas_size - img.width) // 2, (canvas_size - img.height) // 2)
    final_img.paste(img, offset, mask=img)
    
    return final_img

if uploaded_file:
    file_bytes = uploaded_file.read()
    
    # --- PREVIEW SECTION ---
    st.subheader("üîç 1. Preview Result")
    if st.button("Generate Preview"):
        with st.spinner("Processing..."):
            preview_img = process_logic(file_bytes, 0.20)
            st.image(preview_img, caption="Compliant 1:1 Preview", use_container_width=True)
            st.success("Looks good? Proceed to bulk export below.")

    st.divider()

    # --- BULK EXPORT SECTION ---
    st.subheader("üì¶ 2. Bulk Generation")
    if st.button("Generate ZIP (15 Variations)"):
        zip_buffer = io.BytesIO()
        with st.spinner("Creating 15 variations..."):
            with zipfile.ZipFile(zip_buffer, "a", zipfile.ZIP_DEFLATED) as zip_file:
                for i in range(15):
                    # Slight variation in scale (18-22%)
                    scale_var = random.uniform(0.18, 0.22)
                    opt_img = process_logic(file_bytes, scale_var)
                    
                    # Save to JPG
                    buf = io.BytesIO()
                    opt_img.save(buf, format="JPEG", quality=85, optimize=True)
                    zip_file.writestr(f"meesho_listing_{i+1}.jpg", buf.getvalue())
            
            st.download_button(
                label="üì• Download ZIP for Meesho",
                data=zip_buffer.getvalue(),
                file_name="meesho_bulk_images.zip",
                mime="application/zip",
                use_container_width=True
            )
